# Automated Return Processing

This document explains how to configure and operate the automated return workflow that integrates the WMS with the Cargus API.

## 1. Database Migration

Run the migration to add the new metadata columns to the `returns` table:

```bash
php migrate.php --run=2025_09_30_130000_add_auto_return_fields_to_returns
```

The migration introduces the following fields:

- `return_awb` – stores the barcode of the inbound/return airway bill.
- `auto_created` – marks rows generated by the automation layer.
- `return_date` – timestamp for when the carrier flagged the package as returned.

## 2. Configuration

The automation layer reads its settings from `config/config.php` (override values via environment variables):

| Environment variable | Purpose | Default |
| --- | --- | --- |
| `AUTO_RETURN_USER_ID` | User ID assigned to auto-created returns. Must exist. | First `system`/`admin`/`manager` user found |
| `AUTO_RETURN_DELTA_HOURS` | Look-back window (in hours) for delta event sync. | `6` |
| `AUTO_RETURN_NOTIFY_ENABLED` | Enable notification emails (`true`/`false`). | `false` |
| `AUTO_RETURN_NOTIFY_RECIPIENTS` | Comma-separated list of email recipients. | _(empty)_ |
| `AUTO_RETURN_LOG_FILE` | Optional custom log file path. | `storage/logs/automated_returns.log` |

If notifications are enabled, the SMTP settings from the global `email` configuration are used.

## 3. Cron Jobs

Two PHP entry points are available under the `cron/` directory:

- `process_daily_returns.php` – call once per day to fetch `AwbRetur` data.
- `process_delta_events.php` – schedule every hour (or more often) to capture status changes via `AwbTrace/GetDeltaEvents`.

Example crontab:

```
0 6 * * * /usr/bin/php /var/www/wms/cron/process_daily_returns.php >> /var/log/wms/returns.log 2>&1
*/2 * * * * /usr/bin/php /var/www/wms/cron/process_delta_events.php >> /var/log/wms/returns_delta.log 2>&1
```

Both scripts exit with a non-zero code when the sync fails, enabling straightforward monitoring.

## 4. Example Usage (manual invocation)

```php
require_once __DIR__ . '/services/AutomatedReturnProcessor.php';

$processor = new AutomatedReturnProcessor();

// Process returns that Cargus reported for a specific day
$resultDaily = $processor->processDailyReturns('2025-09-29');

// Process delta events using custom range
$resultDelta = $processor->processDeltaEvents('09-29-2025', '09-30-2025');

var_dump($resultDaily, $resultDelta);
```

`createReturnFromAWB()` can also be called directly with a decoded payload from the Cargus API if you need to process bespoke events.

## 5. Monitoring

- Detailed logs are written to `storage/logs/automated_returns.log` by default.
- The returns dashboard now exposes a dedicated “Returnări automate” counter and labels each automated record, making it easier for the warehouse team to triage the items that arrived back without manual intake.

Ensure that the cron user has write permissions to the configured log directory.
